<app-header [userName]="userName"></app-header>

<div class="chat-layout d-flex vh-100">
    <!-- Compact Side Panel -->
    <aside class="side-panel bg-light border-end d-flex flex-column"
        style="width: 280px; min-width: 280px; max-height: calc(100vh - 65px); overflow: hidden;">

        <!-- Scrollable Sessions Section -->
        @if (userObj && userObj.chatSessions && userObj.chatSessions.length > 0) {
        <div class="sessions-section d-flex flex-column" style="min-height: 0;">
            <!-- <div class="sessions-header p-2 border-bottom bg-white">
                <h6 class="mb-0" style="font-size: 0.875rem; font-weight: 600;">Chat Sessions</h6>
            </div> -->
            <div class="sessions-list" style="overflow-y: auto; overflow-x: hidden;">
                <app-chat-session-list class="w-100" [sessions]="userObj.chatSessions"
                    [selectedSession]="selectedSession" (sessionSelected)="onSessionSelected($event)"
                    (newChat)="onNewChat($event)"></app-chat-session-list>
            </div>
        </div>
        }

        <!-- Document Upload Section -->
        @if (selectedChatMode === 'rag' && userId) {
        <div class="document-section border-bottom bg-white">
            <div class="section-header p-2 border-bottom bg-light">
                <h6 class="mb-0 section-header">
                    <i class="fas fa-file-upload me-2"></i>Documents for RAG
                </h6>
            </div>
            <div class="document-content">
                <app-document-upload [userId]="userId" class="compact-upload"></app-document-upload>
            </div>
        </div>
        }


    </aside>

    <!-- Main Chat Area -->
    @if (chatHistory) {
    <div class="chat-container flex-grow-1 d-flex flex-column p-4">
        <app-chat-history [chatHistory]="chatHistory" [isLoading]="isLoading" [errorMessage]="errorMessage"
            [parseMarkdown]="parseMarkdown" [statusMessages]="statusMessages"></app-chat-history>

        <!-- Controls above text area - aligned side by side -->
        <div
            class="controls-above-input d-flex justify-content-start align-items-center p-2 border-bottom bg-light mb-2">
            <div class="flex-grow-3 me-4">
                <app-chat-mode-selector (modeSelected)="onModeSelected($event)" [selectedMode]="selectedChatMode"
                    [supportedModes]="chatModes || []"></app-chat-mode-selector>
            </div>
            <div class="flex-grow-3 ms-4">
                <app-model-selector (modelSelected)="onModelChange($event)"></app-model-selector>
            </div>
        </div>

        <form class="input-bar d-flex align-items-center bg-light p-2 rounded border" (ngSubmit)="sendMessage()">
            <textarea class="form-control me-2" [(ngModel)]="userMessage" name="userMessage" [disabled]="isLoading"
                rows="3" style="resize: none; min-height: 3em; max-height: 8em;" (keydown.enter)="sendMessage()"
                placeholder="Type your message..." autocomplete="off"></textarea>
            <button class="btn btn-primary" type="submit" [disabled]="isLoading || !userMessage.trim()">Send</button>
        </form>
        @if (errorMessage) {
        <div class="error text-danger text-center mt-2">{{ errorMessage }}</div>
        }
    </div>
    }
</div>

<ng-template #userFormModal>
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(127, 127, 127, 0.33);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Information</h5>
                </div>
                <div class="modal-body">
                    <app-user-form (userSubmitted)="onUserFormSubmit($event)"></app-user-form>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #newChatSessionModal>
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(127, 127, 127, 0.33);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Chat Session</h5>
                </div>
                <div class="modal-body">
                    <app-new-chat-session [userId]="userId"
                        (sessionCreated)="onNewChatSessionCreated($event)"></app-new-chat-session>
                </div>
            </div>
        </div>
    </div>
</ng-template>

@if (!userId) {
<ng-container *ngTemplateOutlet="userFormModal"></ng-container>
}
@if (showNewChatModal) {
<ng-container *ngTemplateOutlet="newChatSessionModal"></ng-container>
}